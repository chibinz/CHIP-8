#include <assert.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "console.h"

static const u8 characters[0x200] = {
    0xf0, 0x90, 0x90, 0x90, 0xf0, // 0
    0x20, 0x60, 0x20, 0x20, 0x70, // 1
    0xf0, 0x10, 0xf0, 0x80, 0xf0, // 2
    0xf0, 0x10, 0xf0, 0x10, 0xf0, // 3
    0x90, 0x90, 0xf0, 0x10, 0x10, // 4
    0xf0, 0x80, 0xf0, 0x10, 0xf0, // 5
    0xf0, 0x80, 0xf0, 0x90, 0xf0, // 6
    0xf0, 0x10, 0x20, 0x40, 0x40, // 7
    0xf0, 0x90, 0xf0, 0x90, 0xf0, // 8
    0xf0, 0x90, 0xf0, 0x10, 0xf0, // 9
    0xf0, 0x90, 0xf0, 0x90, 0x90, // A
    0xe0, 0x90, 0xe0, 0x90, 0xe0, // B
    0xf0, 0x80, 0x80, 0x80, 0xf0, // C
    0xe0, 0x90, 0x90, 0x90, 0xe0, // D
    0xf0, 0x80, 0xf0, 0x80, 0xf0, // E
    0xf0, 0x80, 0xf0, 0x80, 0x80, // F
};

cpu cpu_new() {
  return (cpu){
      .r = {0},
      .f = 0,
      .k = 0,
      .dt = 0,
      .st = 0,
      .sp = 0xff,
      .i = 0,
      .pc = 0x200,
      .stack = {0},
  };
}

console console_new() {
  console chip = {.cpu = cpu_new(), .ram = {0}, .fb = {0}, .keypad = {0}};
  memcpy(chip.ram, characters, sizeof(characters));

  return chip;
}

void console_load_rom(console *console, char *rom_path) {
  FILE *rom = fopen(rom_path, "rb");
  if (rom == NULL) {
    printf("Failed to open rom: %s\n", rom_path);
    exit(-1);
  }

  usize len = fread(console->ram + 0x200, 1, 0x1000 - 0x200, rom);
  printf("Rom size: %ld bytes\n", len);
}
